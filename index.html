<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Dojo Core (Fixed)</title>

<button id="run">Run</button>
<button id="reset">Reset</button>

<pre id="out" style="background:#111;color:#0f0;padding:10px;border-radius:10px;min-height:110px"></pre>

<div id="stage" style="
  width:100%;max-width:320px;aspect-ratio:9/16;
  border:1px solid #bbb;border-radius:16px;
  background:#f7f7f7;position:relative;overflow:hidden">
</div>

<script src="https://cdn.jsdelivr.net/npm/fengari-web/dist/fengari-web.js"></script>

<script>
const out = document.getElementById("out");
const stage = document.getElementById("stage");
let running = false;
let tapHandlers = [];

function log(s){ out.textContent += String(s) + "\n"; }

// タップ検知
stage.onclick = (e)=>{
  if(!running) return;
  const r = stage.getBoundingClientRect();
  const x = Math.round(e.clientX - r.left);
  const y = Math.round(e.clientY - r.top);
  tapHandlers.forEach(fn => fn(x,y));
};

// Luaから呼ばれる関数
window.appendOutput = (s)=> out.textContent += String(s);
window.__inputOnTap = (fn)=> tapHandlers.push(fn);

// Luaラッパー（← ここ重要）
function wrap(userCode){
  return `
Input = {}

function Input.onTap(fn)
  js.global:__inputOnTap(fn)
end

print = function(...)
  local t = {}
  for i=1,select('#', ...) do
    t[#t+1] = tostring(select(i, ...))
  end
  js.global:appendOutput(table.concat(t, " ") .. "\\n")
end

${userCode}
`;
}

document.getElementById("run").onclick = ()=>{
  out.textContent = "";
  tapHandlers = [];
  running = true;

  if (!window.fengari || !fengari.load) {
    log("Lua engineが読み込めてない");
    return;
  }

  try {
    const userLua = `
Input.onTap(function(x, y)
  print("Tap:", x, y)
end)

print("Ready! Tap the stage")
`;
    fengari.load(wrap(userLua))();
  } catch (e) {
    log("Lua Error: " + (e.message || e));
  }
};

document.getElementById("reset").onclick = ()=>{
  running = false;
  tapHandlers = [];
  out.textContent = "";
};
</script>