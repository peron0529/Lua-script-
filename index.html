<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LocalScript Dojo - Templates + Autocomplete</title>
  <style>
    body { font-family: -apple-system, system-ui, sans-serif; margin: 12px; }
    h2 { margin: 8px 0; }
    .hint { opacity: .75; font-size: 12px; margin-bottom: 10px; line-height: 1.35; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccc; background: #fff; }
    button:active { transform: scale(0.98); }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }

    pre { white-space: pre-wrap; background: #111; color: #0f0; padding: 10px; border-radius: 12px; min-height: 140px; }

    /* Editor */
    #editor { width: 100%; height: 260px; border:1px solid #ddd; border-radius:12px; overflow:hidden; }

    /* Mock "PlayerGui" area */
    .stageWrap { border: 1px solid #ddd; border-radius: 14px; padding: 10px; }
    .stageTitle { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; gap:10px; }
    .stage {
      position: relative;
      width: 100%;
      aspect-ratio: 9 / 16;
      border-radius: 16px;
      border: 1px solid #bbb;
      overflow: hidden;
      background: #f7f7f7;
      touch-action: manipulation;
    }
    .node { position: absolute; box-sizing: border-box; user-select: none; -webkit-user-select: none; }
    .label {
      display:flex; align-items:center; justify-content:center;
      padding: 6px 8px; border-radius: 12px;
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(255,255,255,0.9);
      font-size: 14px; text-align: center; line-height: 1.2;
    }
    .btn {
      display:flex; align-items:center; justify-content:center;
      padding: 10px 10px; border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.18);
      background: #fff; font-weight: 700;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
    }
    .btn:active { transform: scale(0.99); }
    .small { font-size: 12px; opacity: .7; }

    /* Doc panel */
    #docPanel {
      margin-top:10px; padding:10px;
      border:1px solid #ddd; border-radius:12px;
      background:#fff;
    }
    #docTitle { font-weight: 800; }
    #docBody { margin-top:6px; font-size:13px; opacity:.88; line-height:1.35; white-space:pre-wrap; }
    code { background: rgba(0,0,0,0.06); padding: 1px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <h2>LocalScript道場（予測変換＋テンプレ説明つき）</h2>
  <div class="hint">
    ✅ <b>「l」って打つ</b> → <b>LocalScript風テンプレ</b>が候補に出る → タップで挿入＆右下に説明が出る。<br>
    ※Roblox本物APIじゃない（ブラウザ用の擬似）。でもLocalScriptの考え方（入力→状態→UI更新）が練習できる。
  </div>

  <div class="grid">
    <div>
      <div id="editor"></div>

      <div id="docPanel">
        <div id="docTitle">テンプレ説明</div>
        <div id="docBody">候補をタップすると、ここに「何をするスクリプトか」「どこをいじればいいか」が出る。</div>
      </div>

      <div class="row">
        <button id="run">Run（起動）</button>
        <button id="stop">Stop（停止）</button>
        <button id="clear">Clear（ログ消し）</button>
      </div>

      <h3>Output</h3>
      <pre id="out"></pre>
    </div>

    <div class="stageWrap">
      <div class="stageTitle">
        <div><b>Mock PlayerGui</b> <span class="small">(タップ可)</span></div>
        <button id="resetui">UIリセット</button>
      </div>
      <div id="stage" class="stage"></div>
      <div class="hint" style="margin-top:8px;">
        ここにLuaで作ったTextLabel/Buttonが出る。<br>
        Position/Sizeは <code>UDim2.new(xScale, yScale)</code> の簡略版（0〜1の割合）。
      </div>
    </div>
  </div>

  <!-- Fengari: Lua VM in JS -->
  <script src="https://unpkg.com/fengari-web/dist/fengari-web.js"></script>

  <!-- Monaco Editor (VSCode editor in browser) -->
  <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

  <script>
    const out = document.getElementById("out");
    const stage = document.getElementById("stage");
    const runBtn = document.getElementById("run");
    const stopBtn = document.getElementById("stop");
    const clearBtn = document.getElementById("clear");
    const resetUiBtn = document.getElementById("resetui");

    const docTitle = document.getElementById("docTitle");
    const docBody  = document.getElementById("docBody");

    let editor;
    let running = false;

    // ===== Runtime registries (Mock UI/Input) =====
    let nodesById = new Map(); // id -> {el,type,rect,clickHandlers:[]}
    let tapHandlers = [];
    let nextId = 1;

    function log(s) { out.textContent += s; out.scrollTop = out.scrollHeight; }
    function clearLog() { out.textContent = ""; }

    function resetRuntime() {
      nodesById = new Map();
      tapHandlers = [];
      nextId = 1;
      stage.innerHTML = "";
    }

    function px(v) { return Math.round(v) + "px"; }

    function applyRect(el, rect) {
      const w = stage.clientWidth;
      const h = stage.clientHeight;
      el.style.left = px(rect.xScale * w);
      el.style.top  = px(rect.yScale * h);
      el.style.width  = px(rect.wScale * w);
      el.style.height = px(rect.hScale * h);
    }

    function createNode(type, text) {
      const id = nextId++;
      const el = document.createElement("div");
      el.className = "node " + (type === "TextLabel" ? "label" : "btn");
      el.textContent = String(text ?? "");
      const rect = { xScale: 0.05, yScale: 0.05, wScale: 0.4, hScale: 0.1 };
      applyRect(el, rect);
      stage.appendChild(el);

      const entry = { id, el, type, rect, clickHandlers: [] };

      el.addEventListener("click", () => {
        if (!running) return;
        entry.clickHandlers.forEach(fn => {
          try { fn(); } catch (e) { log("Error: " + e.message + "\n"); }
        });
      });

      nodesById.set(id, entry);
      return id;
    }

    function setText(id, text) {
      const n = nodesById.get(id);
      if (!n) return;
      n.el.textContent = String(text ?? "");
    }

    function setRect(id, xScale, yScale, wScale, hScale) {
      const n = nodesById.get(id);
      if (!n) return;
      n.rect = { xScale, yScale, wScale, hScale };
      applyRect(n.el, n.rect);
    }

    function registerClick(id, fn) {
      const n = nodesById.get(id);
      if (!n) return;
      n.clickHandlers.push(fn);
    }

    function registerTap(fn) { tapHandlers.push(fn); }

    // Tap on stage -> fire Input.onTap
    stage.addEventListener("click", (e) => {
      if (!running) return;
      const r = stage.getBoundingClientRect();
      const x = Math.round(e.clientX - r.left);
      const y = Math.round(e.clientY - r.top);
      tapHandlers.forEach(fn => {
        try { fn(x, y); } catch (err) { log("Error: " + err.message + "\n"); }
      });
    });

    window.addEventListener("resize", () => {
      nodesById.forEach(n => applyRect(n.el, n.rect));
    });

    resetUiBtn.onclick = () => { stage.innerHTML = ""; nodesById.clear(); };

    // Expose to Lua
    window.appendOutput = (s) => log(s);

    window.__uiCreateScreen = (name) => {
      const id = nextId++;
      nodesById.set(id, { id, el: null, type: "ScreenGui", rect: null, clickHandlers: [] });
      return id;
    };
    window.__uiCreateLabel  = (screenId, text) => createNode("TextLabel", text);
    window.__uiCreateButton = (screenId, text) => createNode("TextButton", text);
    window.__uiSetText      = (id, text) => setText(id, text);
    window.__uiSetPosition  = (id, xScale, yScale) => {
      const n = nodesById.get(id); if (!n) return;
      setRect(id, xScale, yScale, n.rect?.wScale ?? 0.4, n.rect?.hScale ?? 0.1);
    };
    window.__uiSetSize      = (id, wScale, hScale) => {
      const n = nodesById.get(id); if (!n) return;
      setRect(id, n.rect?.xScale ?? 0.05, n.rect?.yScale ?? 0.05, wScale, hScale);
    };
    window.__uiOnClick      = (id, fn) => registerClick(id, fn);
    window.__inputOnTap     = (fn) => registerTap(fn);

    function buildLuaWrapper(userCode) {
      return `
-- ========= Mock Roblox-ish =========
UDim2 = {}
function UDim2.new(a, b) return {a=a, b=b} end

UI = {}

function UI.ScreenGui(name)
  return js.global:__uiCreateScreen(tostring(name))
end

local function bindProps(id, obj)
  local mt = {}
  mt.__newindex = function(t, k, v)
    rawset(t, k, v)
    if k == "Text" then
      js.global:__uiSetText(id, tostring(v))
    elseif k == "Position" and type(v) == "table" then
      js.global:__uiSetPosition(id, tonumber(v.a) or 0, tonumber(v.b) or 0)
    elseif k == "Size" and type(v) == "table" then
      js.global:__uiSetSize(id, tonumber(v.a) or 0, tonumber(v.b) or 0)
    end
  end
  setmetatable(obj, mt)
  return obj
end

function UI.TextLabel(screen, text)
  local id = js.global:__uiCreateLabel(screen, tostring(text))
  local obj = {__id=id, Text=text, Position=UDim2.new(0.05,0.05), Size=UDim2.new(0.4,0.1)}
  obj = bindProps(id, obj)
  obj.Text = text
  obj.Position = obj.Position
  obj.Size = obj.Size
  return obj
end

function UI.Button(screen, text)
  local id = js.global:__uiCreateButton(screen, tostring(text))
  local obj = {__id=id, Text=text, Position=UDim2.new(0.05,0.05), Size=UDim2.new(0.4,0.1)}
  obj = bindProps(id, obj)
  function obj:onClick(fn)
    js.global:__uiOnClick(self.__id, fn)
  end
  obj.Text = text
  obj.Position = obj.Position
  obj.Size = obj.Size
  return obj
end

Input = {}
function Input.onTap(fn)
  js.global:__inputOnTap(fn)
end

print = function(...)
  local t = {}
  for i=1,select('#', ...) do t[#t+1] = tostring(select(i, ...)) end
  js.global:appendOutput(table.concat(t, " ") .. "\\n")
end
-- ================================

${userCode}
`;
    }

    runBtn.onclick = () => {
      clearLog();
      resetRuntime();
      running = true;

      try {
        const userLua = editor ? editor.getValue() : "";
        const wrapped = buildLuaWrapper(userLua);
        fengari.load(wrapped)();
        log("[RUNNING] 右の画面にUIが出る。ボタン押す or 画面タップしてみて\n");
      } catch (e) {
        running = false;
        log("Error: " + e.message + "\n");
      }
    };

    stopBtn.onclick = () => {
      running = false;
      log("[STOPPED]\n");
    };

    clearBtn.onclick = () => clearLog();

    // ====== Templates + Autocomplete ======
    function showDoc(t) {
      docTitle.textContent = t.title;
      docBody.textContent = t.doc;
    }

    const LS_TEMPLATES = [
      {
        id: "l.ui_counter",
        title: "l.ui_counter — カウンターUI（＋/−）",
        detail: "UI + 状態（count）+ onClick",
        insert: `-- l.ui_counter: ボタンでカウントを増減
local screen = UI.ScreenGui("Main")

local title = UI.TextLabel(screen, "カウンター")
title.Position = UDim2.new(0.05, 0.05)
title.Size     = UDim2.new(0.90, 0.10)

local count = 0
local label = UI.TextLabel(screen, "回数: 0")
label.Position = UDim2.new(0.05, 0.18)
label.Size     = UDim2.new(0.90, 0.10)

local inc = UI.Button(screen, "＋ ふやす")
inc.Position = UDim2.new(0.05, 0.32)
inc.Size     = UDim2.new(0.43, 0.12)

local dec = UI.Button(screen, "− へらす")
dec.Position = UDim2.new(0.52, 0.32)
dec.Size     = UDim2.new(0.43, 0.12)

inc:onClick(function()
  count = count + 1
  label.Text = "回数: " .. count
end)

dec:onClick(function()
  count = count - 1
  label.Text = "回数: " .. count
end)

print("UI Counter ready!")`,
        doc:
`何が学べる？
- LocalScriptの基本「状態(変数) → UI更新」
- onClickイベントの作り方

いじるならココ
- 初期値: count = 0
- 表示: label.Text を好きな文字に
- 位置/サイズ: Position / Size を変える`
      },

      {
        id: "l.ui_toggle",
        title: "l.ui_toggle — ON/OFFトグル（表示切替）",
        detail: "状態（on/off）でUIのTextを変える",
        insert: `-- l.ui_toggle: ON/OFFを切り替える
local screen = UI.ScreenGui("Main")

local on = false

local label = UI.TextLabel(screen, "状態: OFF")
label.Position = UDim2.new(0.05, 0.08)
label.Size     = UDim2.new(0.90, 0.10)

local btn = UI.Button(screen, "切り替え")
btn.Position = UDim2.new(0.05, 0.22)
btn.Size     = UDim2.new(0.90, 0.12)

btn:onClick(function()
  on = not on
  label.Text = "状態: " .. (on and "ON" or "OFF")
  print("toggle:", on)
end)

print("Toggle ready!")`,
        doc:
`何が学べる？
- bool（true/false）で状態管理
- UIに状態を反映する書き方

いじるならココ
- on の初期値（trueにすると最初ON）
- label.Text の表現を変えてみる`
      },

      {
        id: "l.input_tap_logger",
        title: "l.input_tap_logger — タップ座標ログ",
        detail: "Input.onTapでイベント練習",
        insert: `-- l.input_tap_logger: 画面タップの座標を出す
Input.onTap(function(x, y)
  print("Tap:", x, y)
end)

print("Tap Logger ready! 右の画面をタップして")`,
        doc:
`何が学べる？
- 入力イベント（onTap）
- コールバック関数の形

ポイント
- スマホはキーボードより「タップ」が最強練習`
      },

      {
        id: "l.ui_tap_to_text",
        title: "l.ui_tap_to_text — タップでラベル更新",
        detail: "入力→UI更新（超LocalScript）",
        insert: `-- l.ui_tap_to_text: タップしたらラベルに表示
local screen = UI.ScreenGui("Main")

local label = UI.TextLabel(screen, "タップしてみて")
label.Position = UDim2.new(0.05, 0.10)
label.Size     = UDim2.new(0.90, 0.10)

Input.onTap(function(x, y)
  label.Text = "Tap: " .. x .. ", " .. y
end)

print("Tap -> Text ready!")`,
        doc:
`何が学べる？
- 入力イベントでUIを更新する流れ
- 文字列連結（..）`
      },

      {
        id: "l.ui_multi_buttons",
        title: "l.ui_multi_buttons — 3ボタン（選択UI）",
        detail: "複数ボタンで同じラベルを更新",
        insert: `-- l.ui_multi_buttons: 3つの選択肢
local screen = UI.ScreenGui("Main")

local label = UI.TextLabel(screen, "どれ押す？")
label.Position = UDim2.new(0.05, 0.06)
label.Size     = UDim2.new(0.90, 0.10)

local b1 = UI.Button(screen, "A")
b1.Position = UDim2.new(0.05, 0.22)
b1.Size     = UDim2.new(0.28, 0.12)

local b2 = UI.Button(screen, "B")
b2.Position = UDim2.new(0.36, 0.22)
b2.Size     = UDim2.new(0.28, 0.12)

local b3 = UI.Button(screen, "C")
b3.Position = UDim2.new(0.67, 0.22)
b3.Size     = UDim2.new(0.28, 0.12)

b1:onClick(function() label.Text = "選択: A" end)
b2:onClick(function() label.Text = "選択: B" end)
b3:onClick(function() label.Text = "選択: C" end)

print("Multi buttons ready!")`,
        doc:
`何が学べる？
- UIを複数作ってイベントを分ける
- 同じUIを更新する設計`
      },

      {
        id: "l.logic_timer_counter",
        title: "l.logic_timer_counter — 擬似タイマー（count増）",
        detail: "while + waitっぽい（練習用）",
        insert: `-- l.logic_timer_counter: 擬似タイマーで増えていく
-- ※この道場は本物の wait() がないので、簡易版として「ボタンで1秒進める」方式にする
local screen = UI.ScreenGui("Main")

local t = 0
local label = UI.TextLabel(screen, "t = 0")
label.Position = UDim2.new(0.05, 0.10)
label.Size     = UDim2.new(0.90, 0.10)

local tick = UI.Button(screen, "1秒進める(擬似)")
tick.Position = UDim2.new(0.05, 0.24)
tick.Size     = UDim2.new(0.90, 0.12)

tick:onClick(function()
  t = t + 1
  label.Text = "t = " .. t
end)

print("Pseudo timer ready!")`,
        doc:
`何が学べる？
- 「時間経過で状態が変わる」考え方（本番RobloxでTween/RunServiceに繋がる）
- この道場では wait() が無いのでボタンで擬似的に進める`
      },

      {
        id: "l.starter_template",
        title: "l.starter_template — 最小テンプレ（空から作る用）",
        detail: "まずはこれをベースに改造",
        insert: `-- l.starter_template: ここから作る
local screen = UI.ScreenGui("Main")

local label = UI.TextLabel(screen, "Hello LocalScript Dojo")
label.Position = UDim2.new(0.05, 0.10)
label.Size     = UDim2.new(0.90, 0.10)

local btn = UI.Button(screen, "押して")
btn.Position = UDim2.new(0.05, 0.24)
btn.Size     = UDim2.new(0.90, 0.12)

btn:onClick(function()
  label.Text = "押された！"
end)

Input.onTap(function(x, y)
  print("Tap:", x, y)
end)

print("Starter ready!")`,
        doc:
`何が学べる？
- 最小のUI（Label+Button）
- onClickとonTapの基本形

次の一手
- 変数を追加して「回数」「状態」を持たせてみる`
      }
    ];

    // ===== Monaco setup =====
    const defaultLua = `-- ここで Lua を書く（オートコンプリートあり）
-- まずは "l" と打ってテンプレ候補を出してみて

print("準備OK。l と打つとテンプレ候補が出るよ")`;

    require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.45.0/min/vs" } });

    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById("editor"), {
        value: defaultLua,
        language: "lua",
        theme: "vs",
        automaticLayout: true,
        minimap: { enabled: false },
        fontSize: 14,
        scrollBeyondLastLine: false,
        wordWrap: "on",
        suggest: { showWords: false }
      });

      // コマンド：候補タップ後に説明パネルを更新
      editor.addCommand(0, function(_, templateId) {
        const t = LS_TEMPLATES.find(x => x.id === templateId);
        if (t) showDoc(t);
      }, "ls.showDoc");

      // Completion provider
      monaco.languages.registerCompletionItemProvider("lua", {
        triggerCharacters: ["l", ".", ":"],
        provideCompletionItems: function(model, position) {
          // ここで返すだけで、Monacoが自動でフィルタ（lに一致するものが出る）
          const suggestions = [];

          // LocalScript風テンプレ（l〜）
          for (const t of LS_TEMPLATES) {
            suggestions.push({
              label: t.id, // l.xxx の形にしてあるので「l」で全部出る
              kind: monaco.languages.CompletionItemKind.Snippet,
              insertText: t.insert,
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: t.detail,
              documentation: { value: t.doc.replace(/\n/g, "\n") },
              command: { id: "ls.showDoc", title: "Show template doc", arguments: [t.id] }
            });
          }

          // ついでに基本スニペットも少し（邪魔なら消してOK）
          suggestions.push(
            {
              label: "print",
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: "print(${1:\"text\"})",
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Lua: print"
            },
            {
              label: "function",
              kind: monaco.languages.CompletionItemKind.Keyword,
              insertText: "function ${1:name}(${2:args})\n  ${3}\nend",
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Lua: function snippet"
            },
            {
              label: "UI.Button",
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: "UI.Button(${1:screen}, ${2:\"Button\"})",
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Mock: create Button"
            },
            {
              label: "Input.onTap",
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: "Input.onTap(function(x, y)\n  ${1}\nend)",
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Mock: tap handler"
            },
            {
              label: "UDim2.new",
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: "UDim2.new(${1:0.05}, ${2:0.05})",
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              detail: "Mock: UDim2.new(xScale, yScale)"
            }
          );

          return { suggestions };
        }
      });

      // 初期表示：スターターテンプレの説明
      showDoc(LS_TEMPLATES.find(t => t.id === "l.starter_template") || LS_TEMPLATES[0]);
    });
  </script>
</body>
</html>
