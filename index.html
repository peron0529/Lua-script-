 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/index.html b/index.html
index 731212ccf7042a68dfbfea6c33811ac91a0ea2fc..05619d06a136b41ac06b3929258aaba604f8a2b9 100644
--- a/index.html
+++ b/index.html
@@ -1,109 +1,111 @@
 <!doctype html>
 <html lang="ja">
 <head>
-<meta charset="utf-8" />
-<meta name="viewport" content="width=device-width, initial-scale=1" />
-<title>Dojo (Stable)</title>
-<style>
-  body{margin:0;font-family:-apple-system,system-ui;background:#0f1220;color:#eaeaf0}
-  header{padding:12px;background:#171a2e;font-weight:800;display:flex;justify-content:space-between;align-items:center}
-  #editor{height:62vh}
-  #panel{padding:10px;background:#171a2e;border-top:1px solid rgba(255,255,255,.08)}
-  button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#4c6ef5;color:#fff;font-weight:800}
-  button.ghost{background:transparent}
-  #log{margin-top:10px;font-size:13px;white-space:pre-wrap;opacity:.9;line-height:1.35}
-</style>
-<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
+  <meta charset="utf-8" />
+  <meta name="viewport" content="width=device-width, initial-scale=1" />
+  <title>Lua Local Playground (Single File v2)</title>
+  <style>
+    :root{--bg:#0b1020;--panel:#141b33;--line:rgba(255,255,255,.14);--text:#e8ecff;--accent:#5b8cff;--chip:rgba(255,255,255,.06)}
+    *{box-sizing:border-box}
+    html,body{height:100%}
+    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#0b1020;color:var(--text);display:flex;flex-direction:column}
+    header,footer{background:rgba(20,27,51,.94);border-color:var(--line);border-style:solid;border-width:0}
+    header{padding:14px 18px;border-bottom-width:1px;display:flex;justify-content:space-between;align-items:center}
+    footer{padding:8px 14px;border-top-width:1px;font-size:12px;opacity:.9}
+    #app{display:flex;flex:1;min-height:0}
+    .left{flex:1;min-width:0;background:#11172a;border-right:1px solid var(--line)}
+    .right{width:320px;padding:14px;background:rgba(20,27,51,.94);overflow:auto}
+    #editor{width:100%;height:100%;border:0;outline:none;resize:none;padding:14px;background:#11172a;color:#e9eeff;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:14px;line-height:1.5;tab-size:2}
+    .help{margin:0;font-size:13px;line-height:1.5}
+    .buttons,.chips{display:grid;gap:8px;margin-top:10px}
+    .chips{grid-template-columns:repeat(3,minmax(0,1fr))}
+    button{border:1px solid transparent;border-radius:10px;padding:9px 11px;background:var(--accent);color:#fff;font-size:13px;font-weight:700;cursor:pointer;text-align:left}
+    button.ghost{background:transparent;border-color:var(--line)}
+    .chips button{background:var(--chip);border-color:var(--line);text-align:center}
+    #suggest{margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:hidden;display:none;background:rgba(8,12,26,.9)}
+    #suggest button{border-radius:0;border:0;border-top:1px solid var(--line);background:transparent;width:100%}
+    #suggest button:first-child{border-top:0}
+    #log{margin-top:10px;border:1px solid var(--line);border-radius:10px;min-height:66px;padding:9px;white-space:pre-wrap;font-size:12px;line-height:1.5}
+    @media (max-width:900px){#app{flex-direction:column}.left{min-height:50vh;border-right:0}.right{width:100%;border-top:1px solid var(--line)}}
+  </style>
 </head>
 <body>
+  <header>
+    <strong>Lua Local Script Playground</strong>
+    <span>single-file v2</span>
+  </header>
 
-<header>
-  <div>Dojo Stable</div>
-  <div id="status" style="opacity:.7;font-weight:700">loading...</div>
-</header>
+  <div id="app">
+    <div class="left"><textarea id="editor" spellcheck="false"></textarea></div>
+    <aside class="right">
+      <p class="help">コピペで動く完成版（1ファイル）。この `index.html` だけで起動します。</p>
+      <div class="buttons">
+        <button id="btnSuggest">候補を開く</button>
+        <button id="btnInsert" class="ghost">local function を挿入</button>
+        <button id="btnSample" class="ghost">サンプル</button>
+        <button id="btnReset" class="ghost">リセット</button>
+      </div>
+      <div class="chips">
+        <button type="button" data-insert="local ">local</button>
+        <button type="button" data-insert="function ">function</button>
+        <button type="button" data-insert="end">end</button>
+      </div>
+      <div id="suggest"></div>
+      <div id="log">ready</div>
+    </aside>
+  </div>
 
-<div id="editor"></div>
+  <footer>外部ライブラリなし / もし表示が崩れる場合は .html ファイルとして保存して開いてください</footer>
 
-<div id="panel">
-  <button id="btnSuggest">補完を出す</button>
-  <button id="btnInsert" class="ghost">local を挿入</button>
-  <button id="btnReset" class="ghost">リセット</button>
-  <div id="log">ready.</div>
-</div>
+  <script>
+    const INITIAL = `-- Lua local script を書いてみよう\n\nlocal message = "hello"\nprint(message)\n`;
+    const SAMPLE = `-- local function サンプル\nlocal function greet(name)\n  local text = "Hello, " .. name\n  return text\nend\n\nprint(greet("Lua"))\n`;
+    const SNIPPET = `local function name(args)\n  -- body\nend\n`;
+    const WORDS = ["local ", "local function ", "function ", "end", "if ", "then\n  \nend"];
 
-<script>
-// ===== 画面にエラー表示（iPhone用）=====
-window.onerror = function(msg, src, line, col){
-  const st = document.getElementById("status");
-  const log = document.getElementById("log");
-  if (st) st.textContent = "error";
-  if (log) log.textContent =
-    "JS ERROR:\n" + msg + "\n" + (src||"") + ":" + line + ":" + col;
-};
+    const editor = document.getElementById("editor");
+    const log = document.getElementById("log");
+    const suggest = document.getElementById("suggest");
 
-// ===== 候補（localだけ）=====
-const LS_DB = [
-  { key:"local", desc:"Luaのlocalキーワード", code:"local " },
-];
+    editor.value = INITIAL;
 
-// ===== Monaco起動 =====
-require.config({ paths:{ vs:"https://unpkg.com/monaco-editor@0.45.0/min/vs" }});
-require(["vs/editor/editor.main"], function(){
-  const status = document.getElementById("status");
-  const log = document.getElementById("log");
+    function insertText(text){
+      const start = editor.selectionStart;
+      const end = editor.selectionEnd;
+      editor.setRangeText(text, start, end, "end");
+      editor.focus();
+    }
+    function closeSuggest(){ suggest.style.display = "none"; suggest.innerHTML = ""; }
+    function openSuggest(){
+      suggest.innerHTML = "";
+      WORDS.forEach((word)=>{
+        const btn = document.createElement("button");
+        btn.type = "button";
+        btn.textContent = word.replace(/\n/g, "↵");
+        btn.onclick = ()=>{ insertText(word); log.textContent = `挿入: ${word.replace(/\n/g,"\\n")}`; closeSuggest(); };
+        suggest.appendChild(btn);
+      });
+      suggest.style.display = "block";
+      log.textContent = "候補を表示しました。";
+    }
 
-  try { monaco.languages.register({ id:"lua" }); } catch(e){}
+    document.getElementById("btnSuggest").onclick = openSuggest;
+    document.getElementById("btnInsert").onclick = ()=>{ insertText(SNIPPET); log.textContent = "local function を挿入しました。"; };
+    document.getElementById("btnSample").onclick = ()=>{ editor.value = SAMPLE; closeSuggest(); log.textContent = "サンプル読み込み完了"; };
+    document.getElementById("btnReset").onclick = ()=>{ editor.value = INITIAL; closeSuggest(); log.textContent = "初期化しました"; };
 
-  const editor = monaco.editor.create(document.getElementById("editor"), {
-    value: "-- local と打ってみて\n\n",
-    language: "lua",
-    theme: "vs-dark",
-    minimap: { enabled:false },
-    fontSize: 14,
-    wordWrap: "on",
-    quickSuggestions: true,
-    suggestOnTriggerCharacters: true,
-    tabCompletion: "on"
-  });
+    document.querySelectorAll("[data-insert]").forEach((btn)=>{
+      btn.onclick = ()=>{ insertText(btn.dataset.insert || ""); log.textContent = `挿入: ${btn.dataset.insert}`; };
+    });
 
-  // 補完登録（localだけ）
-  monaco.languages.registerCompletionItemProvider("lua", {
-    provideCompletionItems: () => ({
-      suggestions: LS_DB.map(it => ({
-        label: it.key,
-        kind: monaco.languages.CompletionItemKind.Keyword,
-        insertText: it.code,
-        documentation: it.desc
-      }))
-    })
-  });
-
-  // ボタン
-  document.getElementById("btnSuggest").onclick = ()=>{
-    try { editor.trigger("manual","editor.action.triggerSuggest",{}); } catch(e){}
-  };
-  document.getElementById("btnInsert").onclick = ()=>{
-    const p = editor.getPosition() || {lineNumber:1,column:1};
-    editor.executeEdits("ins", [{
-      range: new monaco.Range(p.lineNumber, p.column, p.lineNumber, p.column),
-      text: "local "
-    }]);
-    editor.focus();
-    log.textContent = "inserted: local";
-  };
-  document.getElementById("btnReset").onclick = ()=>{
-    editor.setValue("-- local と打ってみて\n\n");
-    editor.focus();
-    log.textContent = "reset";
-  };
-
-  // 最初に一回だけ補完を開く（iPhone対策）
-  setTimeout(()=>{ try { editor.trigger("auto","editor.action.triggerSuggest",{}); } catch(e){} }, 250);
-
-  if (status) status.textContent = "ready";
-  log.textContent = "OK：local が候補に出るはず。出なければ『補完を出す』を押して。";
-});
-</script>
+    editor.addEventListener("keydown", (event)=>{
+      if (event.key === "Tab") { event.preventDefault(); insertText("  "); }
+      if (event.key === "Escape") closeSuggest();
+    });
 
+    document.addEventListener("click", (event)=>{
+      if (!suggest.contains(event.target) && event.target.id !== "btnSuggest") closeSuggest();
+    });
+  </script>
 </body>
 </html>
 
EOF
)
